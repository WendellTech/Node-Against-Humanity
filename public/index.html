<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cards Against Humankind</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #252525;
            --accent-color: #e74c3c;
            --text-color: #f5f5f5;
            --white-card-color: #ffffff;
            --black-card-color: #000000;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --czar-color: #f1c40f;
            --border-radius: 12px;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml;charset=utf8,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none" height="100%" width="100%"%3E%3Cpolygon points="0,0 100,0 100,20 0,60" fill="%23252525" opacity="0.5" /%3E%3C/svg%3E');
            background-size: cover;
            background-repeat: no-repeat;
            transition: all 0.5s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(135deg, #e74c3c 0%, #f39c12 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: 700;
            letter-spacing: -1px;
        }

        .screen {
            display: none;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease;
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            color: var(--text-color);
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
        }

        h2:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-color), transparent);
            border-radius: 3px;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background-color: rgba(255,255,255,0.1);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            background-color: rgba(255,255,255,0.2);
            box-shadow: 0 0 0 3px rgba(231,76,60,0.3), inset 0 2px 5px rgba(0,0,0,0.1);
        }

        input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        button:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(255,255,255,0.2);
            transition: width 0.3s ease;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.2);
        }

        button:hover:before {
            width: 100%;
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button.secondary {
            background-color: var(--warning-color);
        }

        button.danger {
            background-color: #c0392b;
        }

        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button:disabled:hover:before {
            width: 0;
        }

        #messages {
            margin: 20px 0;
            padding: 15px;
            border-radius: var(--border-radius);
            background-color: rgba(0,0,0,0.2);
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .message {
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message.error {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--error-color);
            color: #ffffff;
        }

        .message.info {
            background-color: rgba(52, 152, 219, 0.2);
            border-left: 4px solid #3498db;
        }

        .message.success {
            background-color: rgba(46, 204, 113, 0.2);
            border-left: 4px solid var(--success-color);
        }
        
        /* Initial Screen Styling */
        #initial-screen {
            text-align: center;
            max-width: 600px;
        }

        #initial-screen h2 {
            margin-bottom: 40px;
        }
        
        .welcome-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
        }

        /* Create/Join Lobby Styling */
        #create-lobby-screen, #join-lobby-screen {
            max-width: 600px;
        }

        /* Pack Selection Styling */
        .pack-selection-area {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(0,0,0,0.2);
            border-radius: var(--border-radius);
        }

        .pack-selection-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .pack-selection-controls button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .pack-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .pack-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .pack-item label {
            margin-left: 10px;
            cursor: pointer;
            flex-grow: 1;
        }

        .pack-count {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            margin-left: 10px;
        }

        /* Lobby Waiting Screen */
        #lobby-waiting-screen {
            text-align: center;
        }

        #lobby-code-display {
            background-color: var(--accent-color);
            color: white;
            padding: 15px 25px;
            font-size: 2rem;
            letter-spacing: 5px;
            border-radius: var(--border-radius);
            margin: 20px auto;
            display: inline-block;
            font-weight: bold;
            box-shadow: var(--card-shadow);
            animation: pulse 2s infinite;
        }

        #lobby-settings-display, #player-list, #scoreboard {
            background-color: rgba(0,0,0,0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        #player-list ul, #scoreboard ul {
            list-style: none;
            padding: 0;
        }

        #player-list li, #scoreboard li {
            padding: 12px 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            background-color: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #player-list li:hover, #scoreboard li:hover {
            background-color: rgba(255,255,255,0.15);
        }

        .player-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .czar-indicator {
            color: var(--czar-color);
            background-color: rgba(241, 196, 15, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .czar-indicator:before {
            content: "üëë";
            margin-right: 5px;
        }

        .submitted-indicator {
            color: var(--success-color);
            background-color: rgba(46, 204, 113, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            font-size: 0.85rem;
        }

        .submitted-indicator:before {
            content: "‚úì";
            margin-right: 5px;
        }

        .host-indicator:before {
            content: "üè†";
            margin-right: 5px;
        }

        /* Game Screen */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .game-info {
            flex: 1;
            min-width: 250px;
        }

        .game-status {
            background-color: rgba(0,0,0,0.2);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .current-czar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .current-czar span {
            color: var(--czar-color);
            font-weight: 600;
        }
        
        .cards-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 30px;
        }

        .black-card-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 30px;
            perspective: 1000px;
        }

        .black-card-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--czar-color);
        }

        .card {
            position: relative;
            border-radius: 15px;
            padding: 20px;
            height: 220px;
            width: 100%;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
        }

        .black-card {
            background-color: var(--black-card-color);
            color: var(--white-card-color);
            font-size: 1.2em;
            animation: fadeInFlip 0.8s ease;
        }

        @keyframes fadeInFlip {
            0% { opacity: 0; transform: rotateY(90deg); }
            100% { opacity: 1; transform: rotateY(0); }
        }

        .white-card {
            background-color: var(--white-card-color);
            color: var(--black-card-color);
            cursor: pointer;
        }

        .white-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            z-index: 2;
        }

        .white-card.selected {
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transform: translateY(-15px) scale(1.05);
        }

        .card-text {
            flex-grow: 1;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .pick-count {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .black-card .pick-count {
            background-color: rgba(255,255,255,0.3);
        }

        .pack-icon {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 24px;
            height: 24px;
            opacity: 0.8;
        }

        #my-hand-container {
            margin-top: 30px;
            width: 100%;
        }

        #my-hand {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
            perspective: 1000px;
        }

        #cardsToPickCount {
            background-color: var(--accent-color);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Card animation */
        @keyframes dealCard {
            from { 
                opacity: 0; 
                transform: translateY(50px) rotateY(90deg);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) rotateY(0);
            }
        }

        /* Submissions area styling */
        #submissions-area {
            width: 100%;
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        #submissions-area h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--czar-color);
        }

        .submissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .submission-group {
            background-color: rgba(0,0,0,0.3);
            border-radius: var(--border-radius);
            padding: 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .submission-group:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .submission-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }

        .submission-group .white-card {
            margin: 0;
            height: 180px;
            width: 100%;
            cursor: default;
        }

        .submission-group .white-card:hover {
            transform: none;
            box-shadow: var(--card-shadow);
        }

        .choose-winner-btn {
            width: 100%;
            padding: 10px;
            font-size: 0.9rem;
            background-color: var(--czar-color);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .choose-winner-btn:hover {
            background-color: #f39c12;
            transform: translateY(-3px);
        }

        .choose-winner-btn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        /* Round winner and game over info */
        #round-winner-info, #game-over-info {
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        #round-winner-info {
            background-color: rgba(46, 204, 113, 0.2);
            border: 2px solid var(--success-color);
        }

        #game-over-info {
            background-color: rgba(52, 152, 219, 0.2);
            border: 2px solid #3498db;
            font-size: 1.2em;
        }

        #game-over-info ul {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #game-over-info li {
            padding: 8px;
            border-radius: 8px;
            background-color: rgba(255,255,255,0.1);
            margin-bottom: 8px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .screen {
                padding: 20px;
            }

            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }

            #my-hand {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }

            .card {
                height: 180px;
                padding: 15px;
            }

            .submissions-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loading div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: var(--accent-color);
            animation: loading 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }

        .loading div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }

        .loading div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }

        .loading div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }

        @keyframes loading {
            0% {
                top: 8px;
                height: 64px;
            }
            50%, 100% {
                top: 24px;
                height: 32px;
            }
        }

        .loader-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loader-container.active {
            display: flex;
        }

        .loader-text {
            margin-top: 20px;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        /* Czar badge animation */
        @keyframes pulse-crown {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .czar-crown {
            display: inline-block;
            animation: pulse-crown 2s infinite;
            margin-right: 5px;
        }

        /* Card flip animation */
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }

        .flip {
            animation: flip 0.6s ease;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .toast.active {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cards Against Humankind</h1>
        </header>

        <div id="messages"></div>

        <!-- Initial Screen: Enter Name and Join/Create -->
        <div id="initial-screen" class="screen active">
            <h2>Welcome!</h2>
            <input type="text" id="playerName" placeholder="Enter your name" autocomplete="off">
            <div class="welcome-buttons">
                <button id="showCreateLobby" class="primary">Create New Lobby</button>
                <button id="showJoinLobby" class="secondary">Join Existing Lobby</button>
            </div>
        </div>

        <!-- Create Lobby Screen -->
        <div id="create-lobby-screen" class="screen">
            <h2>Create Lobby</h2>
            <div class="settings-form">
                <div>
                    <label for="scoreToWin">Score to Win:</label>
                    <input type="number" id="scoreToWin" value="7" min="3">
                </div>
                <div>
                    <label for="maxPlayers">Max Players:</label>
                    <input type="number" id="maxPlayers" value="10" min="3" max="20">
                </div>
                <div>
                    <label>Select Card Packs:</label>
                    <div class="pack-selection-controls">
                        <button id="selectAllPacks" class="secondary">Select All</button>
                        <button id="selectNonePacks" class="secondary">Select None</button>
                    </div>
                    <div class="pack-selection-area" id="pack-selection-create">
                        <!-- Pack checkboxes will be added here -->
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button id="createLobbyBtn" class="primary">Create Lobby</button>
                <button id="backToInitial" class="secondary">Back</button>
            </div>
        </div>

        <!-- Join Lobby Screen -->
        <div id="join-lobby-screen" class="screen">
            <h2>Join Lobby</h2>
            <input type="text" id="lobbyCodeInput" placeholder="Enter Lobby Code" autocomplete="off">
            <div class="button-group">
                <button id="joinLobbyBtn" class="primary">Join Lobby</button>
                <button id="backToInitialJoin" class="secondary">Back</button>
            </div>
        </div>

        <!-- Lobby Waiting Screen -->
        <div id="lobby-waiting-screen" class="screen">
            <h2>Lobby</h2>
            <div id="lobby-code-display"></div>
            
            <div id="lobby-settings-display">
                <h3>Game Settings</h3>
                <p>Score to Win: <span id="settingScoreToWin"></span></p>
                <p>Max Players: <span id="settingMaxPlayers"></span></p>
                <p>Selected Packs: <span id="settingSelectedPacks"></span></p>
            </div>
            
            <div id="player-list">
                <h3>Players</h3>
                <ul>
                    <!-- Players will be listed here -->
                </ul>
            </div>
            
            <div class="button-group">
                <button id="startGameBtn" class="primary" style="display:none;">Start Game</button>
                <button id="leaveLobbyBtn" class="danger">Leave Lobby</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="game-info game-status">
                    <div class="current-czar"><span class="czar-crown">üëë</span> Card Czar: <span id="currentCzarName">Loading...</span></div>
                    <div>Your Score: <span id="myScore">0</span></div>
                </div>
            </div>

            <div class="cards-area">
                <div class="black-card-container">
                    <h3>Black Card</h3>
                    <div id="black-card-display" class="card black-card">
                        <span class="card-text">Waiting for game to start...</span>
                        <!-- pick-count will be added by JS -->
                    </div>
                </div>

                <div id="submissions-area" style="display:none;">
                    <h3>Card Submissions</h3>
                    <div class="submissions-grid">
                        <!-- Submissions will be populated here -->
                    </div>
                </div>
            </div>
            
            <div id="my-hand-container">
                <h3>Your Hand (<span id="cardsToPickCount"></span>)</h3>
                <div id="my-hand">
                    <!-- White cards will be populated here -->
                </div>
                <button id="submitCardsBtn" style="display:none;">Submit Selection</button>
            </div>

            <div id="round-winner-info" style="display:none;"></div>
            <div id="game-over-info" style="display:none;"></div>
            <button id="nextRoundBtn" style="display:none;" class="secondary">Next Round (Host)</button>


            <div id="scoreboard">
                <h3>Scoreboard</h3>
                <ul>
                    <!-- Scoreboard will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loader-container">
        <div class="loading"><div></div><div></div><div></div></div>
        <div class="loader-text">Loading...</div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // UI Elements
        const screens = {
            initial: document.getElementById('initial-screen'),
            createLobby: document.getElementById('create-lobby-screen'),
            joinLobby: document.getElementById('join-lobby-screen'),
            lobbyWaiting: document.getElementById('lobby-waiting-screen'),
            game: document.getElementById('game-screen')
        };
        const playerNameInput = document.getElementById('playerName');
        const showCreateLobbyBtn = document.getElementById('showCreateLobby');
        const showJoinLobbyBtn = document.getElementById('showJoinLobby');
        
        // Create Lobby UI
        const createLobbyScreen_scoreToWin = document.getElementById('scoreToWin');
        const createLobbyScreen_maxPlayers = document.getElementById('maxPlayers');
        const createLobbyScreen_packSelection = document.getElementById('pack-selection-create');
        const createLobbyBtn = document.getElementById('createLobbyBtn');
        const backToInitialBtn = document.getElementById('backToInitial');
        const selectAllPacksBtn = document.getElementById('selectAllPacks');
        const selectNonePacksBtn = document.getElementById('selectNonePacks');

        // Join Lobby UI
        const lobbyCodeInput = document.getElementById('lobbyCodeInput');
        const joinLobbyBtn = document.getElementById('joinLobbyBtn');
        const backToInitialJoinBtn = document.getElementById('backToInitialJoin');

        // Lobby Waiting UI
        const lobbyCodeDisplay = document.getElementById('lobby-code-display');
        const settingScoreToWinDisplay = document.getElementById('settingScoreToWin');
        const settingMaxPlayersDisplay = document.getElementById('settingMaxPlayers');
        const settingSelectedPacksDisplay = document.getElementById('settingSelectedPacks');
        const playerListUl = document.querySelector('#player-list ul');
        const startGameBtn = document.getElementById('startGameBtn');
        const leaveLobbyBtn = document.getElementById('leaveLobbyBtn');

        // Game UI
        const currentCzarNameDisplay = document.getElementById('currentCzarName');
        const myScoreDisplay = document.getElementById('myScore');
        const blackCardDisplay = document.getElementById('black-card-display');
        const submissionsArea = document.getElementById('submissions-area');
        const myHandContainer = document.getElementById('my-hand-container');
        const myHandDiv = document.getElementById('my-hand');
        const cardsToPickCountSpan = document.getElementById('cardsToPickCount');
        const submitCardsBtn = document.getElementById('submitCardsBtn');
        const scoreboardUl = document.querySelector('#scoreboard ul');
        const roundWinnerInfoDiv = document.getElementById('round-winner-info');
        const gameOverInfoDiv = document.getElementById('game-over-info');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const messagesDiv = document.getElementById('messages');
        const toastElement = document.getElementById('toast');
        const loaderContainer = document.querySelector('.loader-container');

        // Game State
        let currentPlayerName = '';
        let currentLobbyCode = '';
        let currentHand = [];
        let selectedCardsForSubmission = [];
        let pickN = 1; // How many cards to pick for the current black card
        let isHost = false;
        let isCzar = false;
        let allPackData = []; // To store pack info from server {id, name, counts}

        // Helper functions
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
                window.scrollTo(0, 0);
            }
        }

        function showLoader(text = 'Loading...') {
            const loaderTextElement = document.querySelector('.loader-text');
            if (loaderTextElement) loaderTextElement.textContent = text;
            loaderContainer.classList.add('active');
        }

        function hideLoader() {
            loaderContainer.classList.remove('active');
        }

        function showToast(message, type = 'success') {
            toastElement.textContent = message;
            toastElement.className = `toast ${type}`;
            
            setTimeout(() => {
                toastElement.classList.add('active');
                
                setTimeout(() => {
                    toastElement.classList.remove('active');
                }, 3000);
            }, 100);
        }

        function addMessage(text, type = 'info') { // type: info, error, success
            const messageEl = document.createElement('div');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
            if (type === 'error' || type === 'success') {
                setTimeout(() => messageEl.remove(), 5000);
                showToast(text, type);
            }
        }

        function renderPackSelection(containerElement, packs) {
            allPackData = packs; // Store for later display
            containerElement.innerHTML = '';
            
            packs.forEach(pack => {
                const packItem = document.createElement('div');
                packItem.className = 'pack-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = pack.id;
                checkbox.name = 'packs';
                checkbox.id = `pack-${pack.id}`;
                if (pack.id === 0) checkbox.checked = true; // Default select first pack
                
                const label = document.createElement('label');
                label.htmlFor = `pack-${pack.id}`;
                label.textContent = `${pack.name}`;
                
                const countSpan = document.createElement('span');
                countSpan.className = 'pack-count';
                countSpan.textContent = `(White: ${pack.counts.white}, Black: ${pack.counts.black})`;
                
                label.appendChild(countSpan);
                packItem.appendChild(checkbox);
                packItem.appendChild(label);
                containerElement.appendChild(packItem);
            });

            // Initialize Select All/None functionality
            selectAllPacksBtn.onclick = () => {
                const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
            };
            
            selectNonePacksBtn.onclick = () => {
                const checkboxes = containerElement.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            };
        }

        // Event Listeners for screen navigation
        showCreateLobbyBtn.onclick = () => {
            currentPlayerName = playerNameInput.value.trim();
            if (!currentPlayerName) {
                addMessage('Please enter your name.', 'error');
                return;
            }
            showLoader('Getting available card packs...');
            socket.emit('getPackList', (packs) => {
                hideLoader();
                renderPackSelection(createLobbyScreen_packSelection, packs);
                showScreen('createLobby');
            });
        };
        
        showJoinLobbyBtn.onclick = () => {
            currentPlayerName = playerNameInput.value.trim();
            if (!currentPlayerName) {
                addMessage('Please enter your name.', 'error');
                return;
            }
            showScreen('joinLobby');
        };
        
        backToInitialBtn.onclick = () => showScreen('initial');
        backToInitialJoinBtn.onclick = () => showScreen('initial');

        // Create Lobby Logic
        createLobbyBtn.onclick = () => {
            const scoreToWin = parseInt(createLobbyScreen_scoreToWin.value);
            const maxPlayers = parseInt(createLobbyScreen_maxPlayers.value);
            const selectedPackCheckboxes = createLobbyScreen_packSelection.querySelectorAll('input[name="packs"]:checked');
            const selectedPackIndexes = Array.from(selectedPackCheckboxes).map(cb => parseInt(cb.value));

            if (selectedPackIndexes.length === 0) {
                addMessage('Please select at least one card pack.', 'error');
                return;
            }

            showLoader('Creating lobby...');
            const settings = { scoreToWin, maxPlayers, selectedPackIndexes };
            socket.emit('createLobby', { playerName: currentPlayerName, settings }, (response) => {
                hideLoader();
                if (response.success) {
                    currentLobbyCode = response.lobbyCode;
                    isHost = true;
                    lobbyCodeDisplay.textContent = currentLobbyCode;
                    addMessage(`Lobby ${currentLobbyCode} created! Share this code with friends.`, 'success');
                    showScreen('lobbyWaiting');
                } else {
                    addMessage(response.message || 'Failed to create lobby.', 'error');
                }
            });
        };

        // Join Lobby Logic
        joinLobbyBtn.onclick = () => {
            const lobbyCode = lobbyCodeInput.value.trim().toUpperCase();
            if (!lobbyCode) {
                addMessage('Please enter a lobby code.', 'error');
                return;
            }
            
            showLoader('Joining lobby...');
            socket.emit('joinLobby', { lobbyCode, playerName: currentPlayerName }, (response) => {
                hideLoader();
                if (response.success) {
                    currentLobbyCode = response.lobbyCode;
                    isHost = false; // Player joining is not host initially
                    lobbyCodeDisplay.textContent = currentLobbyCode;
                    addMessage(`Joined lobby ${currentLobbyCode}!`, 'success');
                    showScreen('lobbyWaiting');
                } else {
                    addMessage(response.message || 'Failed to join lobby.', 'error');
                }
            });
        };
        
        leaveLobbyBtn.onclick = () => {
            // This will trigger disconnect on server, which should handle cleanup
            socket.disconnect(); 
            socket.connect(); // Re-establish for new session
            currentLobbyCode = '';
            isHost = false;
            isCzar = false;
            showScreen('initial');
            addMessage('You have left the lobby.');
        };

        // Start Game Logic
        startGameBtn.onclick = () => {
            if (isHost && currentLobbyCode) {
                showLoader('Starting game...');
                socket.emit('startGame', { lobbyCode: currentLobbyCode });
            }
        };

        // Render Hand with Animation
        function renderHand(handCards) {
            currentHand = handCards;
            myHandDiv.innerHTML = '';
            selectedCardsForSubmission = []; // Clear selection on new hand
            
            handCards.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card white-card';
                cardDiv.dataset.cardId = card.id;
                cardDiv.style.animation = `dealCard 0.3s ease forwards ${index * 0.1}s`;
                cardDiv.style.opacity = '0'; // Start invisible, animation will fade in
                
                const textSpan = document.createElement('span');
                textSpan.className = 'card-text';
                textSpan.innerHTML = card.text; // Use innerHTML for cards with <b> etc.
                cardDiv.appendChild(textSpan);

                if (card.icon) {
                    const iconImg = document.createElement('img');
                    iconImg.src = `/icons/${card.icon}`;
                    iconImg.alt = 'pack icon';
                    iconImg.className = 'pack-icon';
                    cardDiv.appendChild(iconImg);
                }

                cardDiv.onclick = () => {
                    if (isCzar || !lobbyState || lobbyState.gameState !== 'playing') return; // Can't select if Czar or not in playing state
                    
                    // Add animation
                    cardDiv.classList.add('flip');
                    setTimeout(() => cardDiv.classList.remove('flip'), 600);
                    
                    const alreadySelected = selectedCardsForSubmission.find(selCard => selCard.id === card.id);
                    if (alreadySelected) {
                        // Deselect
                        selectedCardsForSubmission = selectedCardsForSubmission.filter(selCard => selCard.id !== card.id);
                        cardDiv.classList.remove('selected');
                    } else {
                        // Select, but only up to pickN
                        if (selectedCardsForSubmission.length < pickN) {
                            selectedCardsForSubmission.push(card);
                            cardDiv.classList.add('selected');
                        } else if (pickN === 1 && selectedCardsForSubmission.length === 1) {
                            // If pick 1, deselect old and select new
                            const oldSelectedId = selectedCardsForSubmission[0].id;
                            document.querySelector(`.white-card[data-card-id="${oldSelectedId}"]`)?.classList.remove('selected');
                            selectedCardsForSubmission = [card];
                            cardDiv.classList.add('selected');
                        }
                    }
                    submitCardsBtn.disabled = selectedCardsForSubmission.length !== pickN;
                };
                myHandDiv.appendChild(cardDiv);
            });
        }

        // Submit Cards Logic
        submitCardsBtn.onclick = () => {
            if (selectedCardsForSubmission.length === pickN) {
                const cardIds = selectedCardsForSubmission.map(c => c.id);
                socket.emit('submitCards', { lobbyCode: currentLobbyCode, cardIds });
                submitCardsBtn.style.display = 'none'; // Hide after submitting
                addMessage('Cards submitted!', 'success');
            } else {
                addMessage(`Please select ${pickN} card(s).`, 'error');
            }
        };
        
        // Render Black Card
        function renderBlackCard(blackCard) {
            if (!blackCard) {
                blackCardDisplay.querySelector('.card-text').innerHTML = 'Waiting...';
                const existingPickCount = blackCardDisplay.querySelector('.pick-count');
                if (existingPickCount) existingPickCount.remove();
                return;
            }
            
            pickN = blackCard.pick || 1;
            blackCardDisplay.querySelector('.card-text').innerHTML = blackCard.text.replace(/_/g, '______');
            
            let pickCountSpan = blackCardDisplay.querySelector('.pick-count');
            if (!pickCountSpan) {
                pickCountSpan = document.createElement('span');
                pickCountSpan.className = 'pick-count';
                blackCardDisplay.appendChild(pickCountSpan);
            }
            pickCountSpan.textContent = `PICK ${pickN}`;
            cardsToPickCountSpan.textContent = `Select ${pickN} card(s)`;
        }

        // Render Submissions for all players (with Czar functionality)
        function renderSubmissions(submissions) {
            const submissionsGrid = submissionsArea.querySelector('.submissions-grid') || document.createElement('div');
            submissionsGrid.className = 'submissions-grid';
            submissionsGrid.innerHTML = '';
            
            if (!submissions || submissions.length === 0) {
                submissionsArea.style.display = 'none';
                return;
            }
            
            submissionsArea.style.display = 'block';
            
            submissions.forEach((submission, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'submission-group';
                
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'submission-cards';
                
                submission.cards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card white-card';
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'card-text';
                    textSpan.innerHTML = card.text;
                    cardDiv.appendChild(textSpan);
                    
                    cardsContainer.appendChild(cardDiv);
                });
                
                groupDiv.appendChild(cardsContainer);

                // Only the Czar can select winners
                if (isCzar) {
                    const chooseBtn = document.createElement('button');
                    chooseBtn.className = 'choose-winner-btn';
                    chooseBtn.textContent = `Choose as Winner`;
                    chooseBtn.onclick = () => {
                        socket.emit('selectWinner', { lobbyCode: currentLobbyCode, winningPlayerId: submission.playerId });
                        // Disable all buttons after selection
                        document.querySelectorAll('.choose-winner-btn').forEach(btn => btn.disabled = true);
                        chooseBtn.textContent = '‚úÖ Selected as Winner';
                    };
                    groupDiv.appendChild(chooseBtn);
                }
                
                submissionsGrid.appendChild(groupDiv);
            });
            
            submissionsArea.appendChild(submissionsGrid);
        }

        let lobbyState = null; // Store the latest lobby state

        // Socket Event Handlers
        socket.on('lobbyUpdate', (state) => {
            hideLoader(); // Make sure to hide loader when updates received
            lobbyState = state; // cache the state
            currentLobbyCode = state.code; // Ensure this is always up to date
            isHost = state.hostId === socket.id;
            isCzar = state.czarId === socket.id;

            // Update Lobby Waiting Screen
            if (screens.lobbyWaiting.classList.contains('active')) {
                lobbyCodeDisplay.textContent = state.code;
                settingScoreToWinDisplay.textContent = state.settings.scoreToWin;
                settingMaxPlayersDisplay.textContent = state.settings.maxPlayers;
                const packNames = state.settings.selectedPackIndexes
                    .map(idx => allPackData.find(p => p.id === idx)?.name || `Pack ${idx}`)
                    .join(', ');
                settingSelectedPacksDisplay.textContent = packNames || 'Default';

                playerListUl.innerHTML = '';
                state.players.forEach(player => {
                    const li = document.createElement('li');
                    
                    const playerNameDiv = document.createElement('div');
                    playerNameDiv.className = 'player-name';
                    playerNameDiv.textContent = player.name;
                    
                    if (player.id === state.hostId) {
                        const hostSpan = document.createElement('span');
                        hostSpan.className = 'host-indicator';
                        hostSpan.textContent = ' (Host)';
                        playerNameDiv.appendChild(hostSpan);
                    }
                    
                    li.appendChild(playerNameDiv);
                    playerListUl.appendChild(li);
                });
                
                startGameBtn.style.display = isHost ? 'block' : 'none';
            }
            
            // Update Game Screen (if active or game started)
            if (screens.game.classList.contains('active') || state.gameState !== 'waiting') {
                if (screens.lobbyWaiting.classList.contains('active') && state.gameState !== 'waiting') {
                    showScreen('game'); // Transition to game screen if game started
                }

                const me = state.players.find(p => p.id === socket.id);
                myScoreDisplay.textContent = me ? me.score : '0';
                currentCzarNameDisplay.textContent = state.czarName || 'N/A';
                
                renderBlackCard(state.currentBlackCard);

                // Player List and Scoreboard for game screen
                scoreboardUl.innerHTML = '';
                state.players.forEach(player => {
                    const li = document.createElement('li');
                    
                    const playerNameDiv = document.createElement('div');
                    playerNameDiv.className = 'player-name';
                    playerNameDiv.textContent = `${player.name}: ${player.score} points`;
                    
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'player-status';
                    
                    if (player.id === state.czarId) {
                        const czarSpan = document.createElement('span');
                        czarSpan.className = 'czar-indicator';
                        czarSpan.textContent = 'CZAR';
                        statusDiv.appendChild(czarSpan);
                    }
                    
                    if (player.hasSubmitted && player.id !== state.czarId) {
                        const submittedSpan = document.createElement('span');
                        submittedSpan.className = 'submitted-indicator';
                        submittedSpan.textContent = 'Submitted';
                        statusDiv.appendChild(submittedSpan);
                    }
                    
                    li.appendChild(playerNameDiv);
                    li.appendChild(statusDiv);
                    scoreboardUl.appendChild(li);
                });

                roundWinnerInfoDiv.style.display = 'none'; // Hide by default
                gameOverInfoDiv.style.display = 'none';
                nextRoundBtn.style.display = 'none';

                if (state.gameState === 'playing') {
                    submitCardsBtn.style.display = !isCzar ? 'block' : 'none';
                    submitCardsBtn.disabled = selectedCardsForSubmission.length !== pickN;
                    myHandContainer.style.display = !isCzar ? 'block' : 'none';
                    submissionsArea.style.display = 'none';
                    
                    if (isCzar) {
                        addMessage("You are the Card Czar! Wait for submissions.", 'info');
                    } else {
                        const mePlayer = state.players.find(p => p.id === socket.id);
                        if (mePlayer && mePlayer.hasSubmitted) {
                           addMessage("You've submitted. Waiting for others.", 'info');
                           submitCardsBtn.style.display = 'none';
                        } else {
                           addMessage(`Your turn to submit ${pickN} card(s).`, 'info');
                        }
                    }
                } else if (state.gameState === 'judging') {
                    myHandContainer.style.display = !isCzar ? 'none' : 'none';
                    submitCardsBtn.style.display = 'none';
                    renderSubmissions(state.roundSubmissions);
                    
                    if (isCzar) {
                        addMessage("All cards are in! Pick a winner.", 'info');
                    } else {
                        addMessage("Waiting for the Czar to pick a winner...", 'info');
                    }
                } else if (state.gameState === 'roundOver') {
                    myHandContainer.style.display = 'none';
                    submitCardsBtn.style.display = 'none';
                    if (state.roundWinnerInfo) {
                        roundWinnerInfoDiv.innerHTML = `
                            <strong>${state.roundWinnerInfo.winnerName} won the round!</strong><br>
                            Black Card: "${state.roundWinnerInfo.blackCardText}"<br>
                            Winning Combo: "${state.roundWinnerInfo.winningCardsText.join(' / ')}"
                        `;
                        roundWinnerInfoDiv.style.display = 'block';
                    }
                    addMessage("Round over. Next round starting soon...", 'info');
                    if (isHost) nextRoundBtn.style.display = 'block'; // Allow host to manually advance
                } else if (state.gameState === 'gameOver') {
                    // Game Over logic handled by 'gameOver' event primarily
                }
            }
        });

        socket.on('handUpdate', (hand) => {
            renderHand(hand);
        });

        socket.on('gameOver', (data) => {
            showScreen('game'); // Ensure game screen is visible
            gameOverInfoDiv.innerHTML = `<strong>Game Over!</strong><br>${data.winnerName ? `${data.winnerName} is the winner!` : data.message || 'The game has ended.'}<br>Final Scores:`;
            const finalScoresUl = document.createElement('ul');
            data.players.sort((a,b) => b.score - a.score).forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name}: ${p.score}`;
                finalScoresUl.appendChild(li);
            });
            gameOverInfoDiv.appendChild(finalScoresUl);
            gameOverInfoDiv.style.display = 'block';
            
            myHandContainer.style.display = 'none';
            submissionsArea.style.display = 'none';
            submitCardsBtn.style.display = 'none';
            roundWinnerInfoDiv.style.display = 'none';
            document.getElementById('black-card-display').innerHTML = '<span class="card-text">GAME OVER</span>';
            
            addMessage("Game over! Check the final scores.", 'success');
        });
        
        nextRoundBtn.onclick = () => {
            if(isHost && currentLobbyCode && lobbyState && lobbyState.gameState === 'roundOver') {
                socket.emit('requestNextRound', { lobbyCode: currentLobbyCode });
                nextRoundBtn.style.display = 'none'; // Hide after click
            }
        };

        socket.on('gameError', (message) => {
            addMessage(message, 'error');
        });
        
        socket.on('gameMessage', (message) => {
            addMessage(message, 'info');
        });

        socket.on('disconnect', (reason) => {
            hideLoader();
            addMessage(`Disconnected: ${reason}. You can try rejoining or starting a new game.`, 'error');
        });

        // Initial setup
        showScreen('initial');
    </script>
</body>
</html>